"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AsyncGroup = exports.SaveCookies = exports.ParseCookie = exports.CreateRecordInstance = exports.List = exports.Guid = exports.nameof = exports.KeyValuePair = void 0;
var Cst = require("./ConstValue");
var KeyValuePair = (function () {
    function KeyValuePair(_key, _value) {
        this.Key = _key;
        this.Value = _value;
    }
    return KeyValuePair;
}());
exports.KeyValuePair = KeyValuePair;
var nameof = function (name) { return name; };
exports.nameof = nameof;
var Guid = (function () {
    function Guid(value) {
        this.value = this.empty;
        if (value) {
            if (Guid.isValid(value)) {
                this.value = value;
            }
        }
    }
    Guid.newGuid = function () {
        return new Guid('xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0;
            var v = (c == 'x') ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        }));
    };
    Object.defineProperty(Guid, "empty", {
        get: function () {
            return '00000000-0000-0000-0000-000000000000';
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(Guid.prototype, "empty", {
        get: function () {
            return Guid.empty;
        },
        enumerable: false,
        configurable: true
    });
    Guid.isValid = function (str) {
        var validRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
        return validRegex.test(str);
    };
    Guid.prototype.toString = function () {
        return this.value;
    };
    Guid.prototype.toJSON = function () {
        return this.value;
    };
    return Guid;
}());
exports.Guid = Guid;
var List = (function () {
    function List() {
    }
    List.Insert = function (src, item, index) {
        src.splice(index, 0, item);
        return src;
    };
    List.Remove = function (src, index) {
        src.splice(index, 1);
        return src;
    };
    List.Add = function (src, item) {
        src.push(item);
        return src;
    };
    return List;
}());
exports.List = List;
function CreateRecordInstance(instance) {
    var ResRecord = {};
    var Proto = instance;
    while (Proto) {
        Object.keys(Proto).map(function (key) {
            if (!ResRecord[key]) {
                if (typeof Proto[key] === 'function') {
                    ResRecord[key] = Proto[key].bind(instance);
                }
                else {
                }
            }
        });
        Proto = Object.getPrototypeOf(Proto);
    }
    return ResRecord;
}
exports.CreateRecordInstance = CreateRecordInstance;
function ParseCookie(cookieStr) {
    var cookieStrArr = cookieStr.split('=');
    var key = cookieStrArr[0];
    var value = cookieStrArr[1].split(';')[0];
    return new KeyValuePair(key, value);
}
exports.ParseCookie = ParseCookie;
function SaveCookies(NewCookies) {
    if (NewCookies.length > 0) {
        var cookiesMap = {};
        if (wx.getStorageSync(Cst.StorageKey.Cookies)) {
            cookiesMap = JSON.parse(wx.getStorageSync(Cst.StorageKey.Cookies));
        }
        for (var i = 0; i < NewCookies.length; i++) {
            var cookie = ParseCookie(NewCookies[i]);
            cookiesMap[cookie.Key] = cookie.Value;
        }
        wx.setStorageSync(Cst.StorageKey.Cookies, JSON.stringify(cookiesMap));
    }
}
exports.SaveCookies = SaveCookies;
var AsyncGroup = (function () {
    function AsyncGroup(_asyncFuncMap) {
        this.ResultMap = new Map();
        this.lock = false;
        this.AsyncFuncMap = _asyncFuncMap;
        this.CompletedCnt = this.AsyncFuncMap.size;
    }
    AsyncGroup.prototype.Run = function () {
        var _this = this;
        this.AsyncFuncMap.forEach(function (func, key) {
            func(function (result) {
                _this.ResultMap.set(key, result);
                _this.CheckComplete();
            });
        });
        return this;
    };
    AsyncGroup.prototype.ContinueWith = function (callback) {
        this.Complete = callback;
        return this;
    };
    AsyncGroup.prototype.CheckComplete = function () {
        while (this.lock) { }
        this.lock = true;
        this.CompletedCnt--;
        if (this.CompletedCnt == 0) {
            this.Complete(this.ResultMap);
        }
        this.lock = false;
    };
    return AsyncGroup;
}());
exports.AsyncGroup = AsyncGroup;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJVdGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxrQ0FBcUM7QUFDckM7SUFHSSxzQkFBWSxJQUFTLEVBQUUsTUFBVztRQUM5QixJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQztRQUNoQixJQUFJLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQztJQUN4QixDQUFDO0lBQ0wsbUJBQUM7QUFBRCxDQUFDLEFBUEQsSUFPQztBQVBZLG9DQUFZO0FBU2xCLElBQU0sTUFBTSxHQUFHLFVBQUksSUFBYSxJQUFLLE9BQUEsSUFBSSxFQUFKLENBQUksQ0FBQztBQUFwQyxRQUFBLE1BQU0sVUFBOEI7QUFFakQ7SUFtQkMsY0FBWSxLQUFjO1FBRGxCLFVBQUssR0FBVyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRWxDLElBQUksS0FBSyxFQUFFO1lBQ1YsSUFBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUN2QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQzthQUNuQjtTQUNEO0lBQ0YsQ0FBQztJQXhCYSxZQUFPLEdBQXJCO1FBQ0MsT0FBTyxJQUFJLElBQUksQ0FBQyxzQ0FBc0MsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLFVBQUEsQ0FBQztZQUN4RSxJQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUNqQyxJQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUM7WUFDM0MsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZCLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0Qsc0JBQWtCLGFBQUs7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QUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUN6QixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBR08sa0NBQWEsR0FBckI7UUFDSSxPQUFNLElBQUksQ0FBQyxJQUFJLEVBQUMsR0FBRTtRQUNsQixJQUFJLENBQUMsSUFBSSxHQUFDLElBQUksQ0FBQztRQUNmLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNwQixJQUFJLElBQUksQ0FBQyxZQUFZLElBQUksQ0FBQyxFQUFFO1lBQ3hCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1NBQ2hDO1FBQ0QsSUFBSSxDQUFDLElBQUksR0FBQyxLQUFLLENBQUM7SUFDcEIsQ0FBQztJQUNMLGlCQUFDO0FBQUQsQ0FBQyxBQXRDRCxJQXNDQztBQXRDWSxnQ0FBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBDc3QgPSByZXF1aXJlKFwiLi9Db25zdFZhbHVlXCIpO1xyXG5leHBvcnQgY2xhc3MgS2V5VmFsdWVQYWlyPFRfSywgVF9WPntcclxuICAgIHB1YmxpYyBLZXk6IFRfSztcclxuICAgIHB1YmxpYyBWYWx1ZTogVF9WO1xyXG4gICAgY29uc3RydWN0b3IoX2tleTogVF9LLCBfdmFsdWU6IFRfVikge1xyXG4gICAgICAgIHRoaXMuS2V5ID0gX2tleTtcclxuICAgICAgICB0aGlzLlZhbHVlID0gX3ZhbHVlO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgY29uc3QgbmFtZW9mID0gPFQ+KG5hbWU6IGtleW9mIFQpID0+IG5hbWU7XHJcblxyXG5leHBvcnQgY2xhc3MgR3VpZCB7XHJcblx0cHVibGljIHN0YXRpYyBuZXdHdWlkKCk6IEd1aWQge1xyXG5cdFx0cmV0dXJuIG5ldyBHdWlkKCd4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4eV0vZywgYyA9PiB7XHJcblx0XHRcdGNvbnN0IHIgPSBNYXRoLnJhbmRvbSgpICogMTYgfCAwO1xyXG5cdFx0XHRjb25zdCB2ID0gKGMgPT0gJ3gnKSA/IHIgOiAociAmIDB4MyB8IDB4OCk7XHJcblx0XHRcdHJldHVybiB2LnRvU3RyaW5nKDE2KTtcclxuXHRcdH0pKTtcclxuXHR9XHJcblx0cHVibGljIHN0YXRpYyBnZXQgZW1wdHkoKTogc3RyaW5nIHtcclxuXHRcdHJldHVybiAnMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAwJztcclxuXHR9XHJcblx0cHVibGljIGdldCBlbXB0eSgpOiBzdHJpbmcge1xyXG5cdFx0cmV0dXJuIEd1aWQuZW1wdHk7XHJcblx0fVxyXG5cdHB1YmxpYyBzdGF0aWMgaXNWYWxpZChzdHI6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG5cdFx0Y29uc3QgdmFsaWRSZWdleCA9IC9eWzAtOWEtZl17OH0tWzAtOWEtZl17NH0tWzEtNV1bMC05YS1mXXszfS1bODlhYl1bMC05YS1mXXszfS1bMC05YS1mXXsxMn0kL2k7XHJcblx0XHRyZXR1cm4gdmFsaWRSZWdleC50ZXN0KHN0cik7XHJcblx0fVxyXG5cdHByaXZhdGUgdmFsdWU6IHN0cmluZyA9IHRoaXMuZW1wdHk7XHJcblx0Y29uc3RydWN0b3IodmFsdWU/OiBzdHJpbmcpIHtcclxuXHRcdGlmICh2YWx1ZSkge1xyXG5cdFx0XHRpZihHdWlkLmlzVmFsaWQodmFsdWUpKSB7XHJcblx0XHRcdFx0dGhpcy52YWx1ZSA9IHZhbHVlO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0fVxyXG5cdHB1YmxpYyB0b1N0cmluZygpIHtcclxuXHRcdHJldHVybiB0aGlzLnZhbHVlO1xyXG5cdH1cclxuXHJcblx0cHVibGljIHRvSlNPTigpOiBzdHJpbmcge1xyXG5cdFx0cmV0dXJuIHRoaXMudmFsdWU7XHJcblx0fVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgTGlzdHtcclxuICAgIHB1YmxpYyBzdGF0aWMgSW5zZXJ0PFQ+KHNyYzpBcnJheTxUPixpdGVtOlQsaW5kZXg6bnVtYmVyKSB7XHJcbiAgICAgICAgc3JjLnNwbGljZShpbmRleCwgMCwgaXRlbSk7XHJcbiAgICAgICAgcmV0dXJuIHNyYztcclxuICAgIH1cclxuICAgIHB1YmxpYyBzdGF0aWMgUmVtb3ZlPFQ+KHNyYzogQXJyYXk8VD4saW5kZXg6IG51bWJlcikge1xyXG4gICAgICAgIHNyYy5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgIHJldHVybiBzcmM7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgc3RhdGljIEFkZDxUPihzcmM6IEFycmF5PFQ+LGl0ZW06IFQpIHtcclxuICAgICAgICBzcmMucHVzaChpdGVtKTtcclxuICAgICAgICByZXR1cm4gc3JjO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gQ3JlYXRlUmVjb3JkSW5zdGFuY2UoaW5zdGFuY2U6YW55KXtcclxuICAgIGxldCBSZXNSZWNvcmQ6UmVjb3JkPHN0cmluZywgYW55PiA9e31cclxuICAgIHR5cGUgS19UID0ga2V5b2YgdHlwZW9mIGluc3RhbmNlOyBcclxuICAgIGxldCBQcm90byA9IGluc3RhbmNlO1xyXG4gICAgd2hpbGUoUHJvdG8pe1xyXG4gICAgICAgIE9iamVjdC5rZXlzKFByb3RvKS5tYXAoa2V5ID0+IHtcclxuICAgICAgICAgICAgaWYoIVJlc1JlY29yZFtrZXldKXtcclxuICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBQcm90b1trZXkgYXMgS19UXSA9PT0gJ2Z1bmN0aW9uJyl7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICAgICAgUmVzUmVjb3JkW2tleV0gPSAoUHJvdG9ba2V5IGFzIEtfVF0gYXMgRnVuY3Rpb24pLmJpbmQoaW5zdGFuY2UpO1xyXG4gICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9SZXNSZWNvcmRba2V5XSA9IFByb3RvW2tleSBhcyBLX1RdXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICAgIFByb3RvID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKFByb3RvKTtcclxuICAgIH1cclxuICAgIHJldHVybiBSZXNSZWNvcmQ7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBQYXJzZUNvb2tpZShjb29raWVTdHI6IHN0cmluZyk6IEtleVZhbHVlUGFpcjxzdHJpbmcsIHN0cmluZz4ge1xyXG4gICAgbGV0IGNvb2tpZVN0ckFycjogc3RyaW5nW10gPSBjb29raWVTdHIuc3BsaXQoJz0nKTtcclxuICAgIGxldCBrZXk6IHN0cmluZyA9IGNvb2tpZVN0ckFyclswXTtcclxuICAgIGxldCB2YWx1ZTogc3RyaW5nID0gY29va2llU3RyQXJyWzFdLnNwbGl0KCc7JylbMF07XHJcbiAgICByZXR1cm4gbmV3IEtleVZhbHVlUGFpcjxzdHJpbmcsIHN0cmluZz4oa2V5LCB2YWx1ZSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBTYXZlQ29va2llcyhOZXdDb29raWVzOiBzdHJpbmdbXSkge1xyXG4gICAgaWYgKE5ld0Nvb2tpZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGxldCBjb29raWVzTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XHJcbiAgICAgICAgaWYgKHd4LmdldFN0b3JhZ2VTeW5jKENzdC5TdG9yYWdlS2V5LkNvb2tpZXMpKSB7XHJcbiAgICAgICAgICAgIGNvb2tpZXNNYXAgPSBKU09OLnBhcnNlKHd4LmdldFN0b3JhZ2VTeW5jKENzdC5TdG9yYWdlS2V5LkNvb2tpZXMpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBOZXdDb29raWVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGxldCBjb29raWU6IEtleVZhbHVlUGFpcjxzdHJpbmcsIHN0cmluZz4gPSBQYXJzZUNvb2tpZShOZXdDb29raWVzW2ldKTtcclxuICAgICAgICAgICAgY29va2llc01hcFtjb29raWUuS2V5XSA9IGNvb2tpZS5WYWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgd3guc2V0U3RvcmFnZVN5bmMoQ3N0LlN0b3JhZ2VLZXkuQ29va2llcywgSlNPTi5zdHJpbmdpZnkoY29va2llc01hcCkpO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgQXN5bmNHcm91cCB7XHJcbiAgICBwcml2YXRlIEFzeW5jRnVuY01hcDogTWFwPHN0cmluZywgKGNhbGxiYWNrOiAocmVzdWx0OiBhbnkpID0+IHZvaWQpID0+IGFueT5cclxuICAgIHByaXZhdGUgUmVzdWx0TWFwOiBNYXA8c3RyaW5nLCBhbnk+ID1uZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG4gICAgcHJpdmF0ZSBDb21wbGV0ZWRDbnQ6bnVtYmVyO1xyXG5cclxuICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgcHJpdmF0ZSBDb21wbGV0ZTogKHJlc3VsdDogTWFwPHN0cmluZywgYW55PikgPT4gdm9pZCA7XHJcblxyXG4gICAgY29uc3RydWN0b3IoX2FzeW5jRnVuY01hcDogTWFwPHN0cmluZywgKGNhbGxiYWNrOiAocmVzdWx0OmFueSkgPT4gdm9pZCkgPT4gYW55Pikge1xyXG4gICAgICAgIHRoaXMuQXN5bmNGdW5jTWFwID0gX2FzeW5jRnVuY01hcDtcclxuICAgICAgICB0aGlzLkNvbXBsZXRlZENudCA9IHRoaXMuQXN5bmNGdW5jTWFwLnNpemU7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHB1YmxpYyBSdW4oKTogQXN5bmNHcm91cCB7XHJcbiAgICAgICAgdGhpcy5Bc3luY0Z1bmNNYXAuZm9yRWFjaCgoZnVuYywga2V5KSA9PiB7XHJcbiAgICAgICAgICAgIGZ1bmMoKHJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5SZXN1bHRNYXAuc2V0KGtleSwgcmVzdWx0KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuQ2hlY2tDb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBDb250aW51ZVdpdGgoY2FsbGJhY2s6IChyZXN1bHQ6IE1hcDxzdHJpbmcsIGFueT4pID0+IHZvaWQpOkFzeW5jR3JvdXAge1xyXG4gICAgICAgIHRoaXMuQ29tcGxldGUgPSBjYWxsYmFjaztcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGxvY2s6Ym9vbGVhbj1mYWxzZTtcclxuICAgIHByaXZhdGUgQ2hlY2tDb21wbGV0ZSgpIHtcclxuICAgICAgICB3aGlsZSh0aGlzLmxvY2spe31cclxuICAgICAgICB0aGlzLmxvY2s9dHJ1ZTtcclxuICAgICAgICB0aGlzLkNvbXBsZXRlZENudC0tO1xyXG4gICAgICAgIGlmICh0aGlzLkNvbXBsZXRlZENudCA9PSAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuQ29tcGxldGUodGhpcy5SZXN1bHRNYXApXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubG9jaz1mYWxzZTtcclxuICAgIH1cclxufSJdfQ==