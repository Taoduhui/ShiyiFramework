"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.ShiyiPageBase = exports.ShiyiPageUIBase = exports.ShiyiPageFuncBase = void 0;
var Router_1 = require("../../Router/Router");
var GlobalData_1 = require("../../../GlobalData/GlobalData");
var ShiyiPageExternBase = (function () {
    function ShiyiPageExternBase() {
    }
    Object.defineProperty(ShiyiPageExternBase.prototype, "Inst", {
        get: function () {
            return this.PageInstance;
        },
        enumerable: false,
        configurable: true
    });
    ShiyiPageExternBase.prototype.Init = function () {
        this._Render = this.PageInstance.Render.bind(this.PageInstance);
        this.data = this.PageInstance.data;
        return this;
    };
    ShiyiPageExternBase.prototype.Render = function (value) {
        this._Render(value);
    };
    return ShiyiPageExternBase;
}());
var ShiyiPageFuncBase = (function (_super) {
    __extends(ShiyiPageFuncBase, _super);
    function ShiyiPageFuncBase() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    return ShiyiPageFuncBase;
}(ShiyiPageExternBase));
exports.ShiyiPageFuncBase = ShiyiPageFuncBase;
var ShiyiPageUIBase = (function (_super) {
    __extends(ShiyiPageUIBase, _super);
    function ShiyiPageUIBase() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    ShiyiPageUIBase.prototype.Init = function () {
        _super.prototype.Init.call(this);
        this.LoadGlobalUIConfig();
        return this;
    };
    ShiyiPageUIBase.prototype.LoadGlobalUIConfig = function () {
        this.PageInstance.BindGlobal(GlobalData_1.GlobalData.Theme, "Theme", function (value) {
            return value ? "Dark" : "";
        });
    };
    return ShiyiPageUIBase;
}(ShiyiPageExternBase));
exports.ShiyiPageUIBase = ShiyiPageUIBase;
var ShiyiPageBase = (function () {
    function ShiyiPageBase() {
        this.ComponentStack = new Array();
        this.RegisteredEventHandlers = {};
        this.ObserverList = {};
        this.RegisteredGlobalBackWardBinding = {};
        this.RegisteredSelfBinding = {};
    }
    ShiyiPageBase.prototype.BindEvent = function (Trigger, Handler) {
        this.AddHandler(Trigger, Handler);
    };
    ShiyiPageBase.prototype.AddHandler = function (Trigger, Handler) {
        this.RegisteredEventHandlers[Trigger] = Handler;
    };
    ShiyiPageBase.prototype.Removehandler = function (Trigger, Handler) {
        if (this.RegisteredEventHandlers[Trigger] === Handler) {
            delete this.RegisteredEventHandlers[Trigger];
        }
    };
    ShiyiPageBase.prototype.EventHandler = function (e) {
        e.Catch();
        var Handler = this.RegisteredEventHandlers[e.EventName];
        console.log(Handler);
        if (Handler) {
            Handler(e);
        }
        else {
            e.Pass();
        }
    };
    ShiyiPageBase.prototype.AddObserver = function (data, target) {
        this.ObserverList[data.DataKey] = target;
        data.Bind(this);
    };
    ShiyiPageBase.prototype.RemoveObserver = function (data) {
        if (this.ObserverList[data.DataKey]) {
            delete this.ObserverList[data.DataKey];
        }
    };
    ShiyiPageBase.prototype.ObserverNotify = function (key, value) {
        var _a;
        var target = this.ObserverList[key];
        if (target) {
            this.RenderNoBackward((_a = {},
                _a[target.name] = target.PreProcess ? target.PreProcess(value) : value,
                _a));
        }
    };
    ShiyiPageBase.prototype.BindGlobal = function (GlobalData, SelfDataKey, PreProcess) {
        this.AddObserver(GlobalData, {
            name: SelfDataKey,
            PreProcess: PreProcess
        });
    };
    ShiyiPageBase.prototype.BindGlobalBackward = function (SelfDataKey, GlobalDataObj, PreProcess) {
        if (!this.RegisteredGlobalBackWardBinding[SelfDataKey]) {
            this.RegisteredGlobalBackWardBinding[SelfDataKey] = new Array();
        }
        this.RegisteredGlobalBackWardBinding[SelfDataKey].push({
            "TargetDataObj": GlobalDataObj,
            "PreProcess": PreProcess
        });
    };
    ShiyiPageBase.prototype.BindGlobalTwoWay = function (SelfDataKey, GlobalDataObj, SelfToGlobalPreProcess, GlobalToSelfPreProcess) {
        this.BindGlobal(GlobalDataObj, SelfDataKey, GlobalToSelfPreProcess);
        this.BindGlobalBackward(SelfDataKey, GlobalDataObj, SelfToGlobalPreProcess);
    };
    ShiyiPageBase.prototype.BindSelf = function (SrcKey, TargetKey, PreProcess) {
        if (!this.RegisteredSelfBinding[SrcKey]) {
            this.RegisteredSelfBinding[SrcKey] = new Array();
        }
        this.RegisteredSelfBinding[SrcKey].push({
            name: TargetKey,
            PreProcess: PreProcess
        });
    };
    ShiyiPageBase.prototype.BindSelfTwoWay = function (FirstData, SecData, FirstToSecPreProcess, SecToFirstPreProcess) {
        this.BindSelf(FirstData, SecData, FirstToSecPreProcess);
        this.BindSelf(SecData, FirstData, SecToFirstPreProcess);
    };
    ShiyiPageBase.prototype.Render = function (value) {
        this._render(value, false);
    };
    ShiyiPageBase.prototype.RenderNoBackward = function (value) {
        this._render(value, true);
    };
    ShiyiPageBase.prototype._render = function (value, DisableBackward) {
        var _this = this;
        var Modified = false;
        var Keys = Object.keys(value);
        Keys.forEach(function (key) {
            if (_this.RegisteredSelfBinding[key]) {
                _this.RegisteredSelfBinding[key].forEach(function (target) {
                    if (Keys.indexOf(target.name) < 0) {
                        Modified = true;
                        if (target.PreProcess) {
                            value[target.name] = target.PreProcess(value[key]);
                        }
                        else {
                            value[target.name] = value[key];
                        }
                    }
                });
            }
            if (!DisableBackward && _this.RegisteredGlobalBackWardBinding[key]) {
                _this.RegisteredGlobalBackWardBinding[key].forEach(function (target) {
                    target.TargetDataObj.Set(target.PreProcess ?
                        target.PreProcess(value[key]) :
                        value[key]);
                });
            }
        });
        if (Modified) {
            this._render(value, DisableBackward);
            return;
        }
        this.setData(value);
    };
    ShiyiPageBase.prototype.LoadPesudoComponents = function () {
        var _this = this;
        var components = this.PesudoCompnents;
        Object.keys(components).forEach(function (key) {
            var Comp = components[key];
            Comp.PageInstance = _this;
            Comp._Render = _this.Render.bind(_this);
            var CompProto = Comp;
            var CompId = components[key].ComponentId;
            while (CompProto) {
                Object.keys(CompProto).forEach(function (key) {
                    if (typeof CompProto[key] == "function") {
                        _this[CompId + key] = CompProto[key].bind(Comp);
                    }
                });
                CompProto = Object.getPrototypeOf(CompProto);
            }
            var CompData = {};
            Object.keys(components[key].data).forEach(function (datakey) {
                CompData[CompId + datakey] = components[key].data[datakey];
            });
            _this.Render(CompData);
        });
    };
    ShiyiPageBase.prototype.LoadExtends = function () {
        this.Func.PageInstance = this;
        this.Func.Init();
        this.UI.PageInstance = this;
        this.UI.Init();
        this.UI.InitCustomData();
        this.Func.InitCustomData();
    };
    ShiyiPageBase.prototype.onLoad = function () {
        Router_1.Router.PageLoad(this);
        this.LoadPesudoComponents();
        this.LoadExtends();
        this.InParameter = Router_1.Router.NavigateParam;
    };
    ShiyiPageBase.prototype.onUnload = function () {
        Router_1.Router.PageUnload();
    };
    return ShiyiPageBase;
}());
exports.ShiyiPageBase = ShiyiPageBase;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2hpeWlQYWdlQmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlNoaXlpUGFnZUJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUEsOENBQTZDO0FBRTdDLDBEQUF5RDtBQUt6RDtJQU9JO0lBQ0EsQ0FBQztJQU5ELHNCQUFXLHFDQUFJO2FBQWY7WUFDSSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7UUFDN0IsQ0FBQzs7O09BQUE7SUFNTSxrQ0FBSSxHQUFYO1FBQ0ksSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUM7UUFDbkMsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUdNLG9DQUFNLEdBQWIsVUFBa0MsS0FBb0M7UUFDbEUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN4QixDQUFDO0lBQ0wsMEJBQUM7QUFBRCxDQUFDLEFBcEJELElBb0JDO0FBRUQ7SUFBNkUscUNBQTBCO0lBQXZHOztJQUNBLENBQUM7SUFBRCx3QkFBQztBQUFELENBQUMsQUFERCxDQUE2RSxtQkFBbUIsR0FDL0Y7QUFEcUIsOENBQWlCO0FBR3ZDO0lBQTJFLG1DQUEwQjtJQUFyRzs7SUFhQSxDQUFDO0lBWlUsOEJBQUksR0FBWDtRQUNJLGlCQUFNLElBQUksV0FBRSxDQUFDO1FBQ2IsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFDMUIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUNNLDRDQUFrQixHQUF6QjtRQUNJLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLHVCQUFVLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFDbEQsVUFBQyxLQUFjO1lBQ1gsT0FBTyxLQUFLLENBQUMs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Q0FBQztJQUM1QyxDQUFDO0lBRU0sZ0NBQVEsR0FBZjtRQUNJLGVBQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBQ0wsb0JBQUM7QUFBRCxDQUFDLEFBaFBELElBZ1BDO0FBaFBxQixzQ0FBYTtBQWdQbEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNoaXlpQ29tcG9uZW50QmFzZSB9IGZyb20gXCIuLi8uLi9TaGl5aUNvbXBvbmVudC9CYXNlL0NvbXBvbmVudHNCYXNlXCI7XHJcbmltcG9ydCB7IEV2ZW50IH0gZnJvbSBcIi4uLy4uL0V2ZW50L0V2ZW50XCI7XHJcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gXCIuLi8uLi9Sb3V0ZXIvUm91dGVyXCI7XHJcbmltcG9ydCB7IERhdGEgfSBmcm9tIFwiLi4vLi4vRGF0YS9EYXRhXCI7XHJcbmltcG9ydCB7IEdsb2JhbERhdGEgfSBmcm9tIFwiQFJvb3QvR2xvYmFsRGF0YS9HbG9iYWxEYXRhXCI7XHJcbmltcG9ydCB7IG5hbWVvZiB9IGZyb20gXCJAUm9vdC9TaGl5aUZyYW1ld29yay9VdGlscy9VdGlsc1wiO1xyXG5pbXBvcnQgeyBQZXN1ZG9Db21wbmVudCB9IGZyb20gXCJAUm9vdC9TaGl5aUZyYW1ld29yay9TaGl5aVBlc3Vkb0NvbXBuZW50L1Blc3Vkb0NvbXBuZW50XCI7XHJcblxyXG5cclxuYWJzdHJhY3QgY2xhc3MgU2hpeWlQYWdlRXh0ZXJuQmFzZTxQYWdlVCBleHRlbmRzIFNoaXlpUGFnZUJhc2U+IHtcclxuICAgIHB1YmxpYyBQYWdlSW5zdGFuY2UhOiBQYWdlVFxyXG4gICAgcHVibGljIGdldCBJbnN0KCk6IFBhZ2VUIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5QYWdlSW5zdGFuY2U7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgX1JlbmRlciE6ICh2YWx1ZTogUmVjb3JkPHN0cmluZywgYW55PikgPT4gdm9pZDtcclxuICAgIHB1YmxpYyBkYXRhITogUmVjb3JkPHN0cmluZywgYW55PjtcclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBJbml0KCk6IFNoaXlpUGFnZUV4dGVybkJhc2U8UGFnZVQ+IHtcclxuICAgICAgICB0aGlzLl9SZW5kZXIgPSB0aGlzLlBhZ2VJbnN0YW5jZS5SZW5kZXIuYmluZCh0aGlzLlBhZ2VJbnN0YW5jZSk7XHJcbiAgICAgICAgdGhpcy5kYXRhID0gdGhpcy5QYWdlSW5zdGFuY2UuZGF0YTtcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuICAgIHB1YmxpYyBhYnN0cmFjdCBJbml0Q3VzdG9tRGF0YShfb3B0aW9ucz86IFJlY29yZDxzdHJpbmcsIGFueT4gfCB1bmRlZmluZWQpOiB2b2lkO1xyXG5cclxuICAgIHB1YmxpYyBSZW5kZXI8VCBleHRlbmRzIFBhZ2VEYXRhPih2YWx1ZTogUGFydGlhbDxSZWNvcmQ8a2V5b2YgVCwgYW55Pj4pOiB2b2lkIHtcclxuICAgICAgICB0aGlzLl9SZW5kZXIodmFsdWUpO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU2hpeWlQYWdlRnVuY0Jhc2U8UGFnZVQgZXh0ZW5kcyBTaGl5aVBhZ2VCYXNlPiBleHRlbmRzIFNoaXlpUGFnZUV4dGVybkJhc2U8UGFnZVQ+IHtcclxufVxyXG5cclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFNoaXlpUGFnZVVJQmFzZTxQYWdlVCBleHRlbmRzIFNoaXlpUGFnZUJhc2U+IGV4dGVuZHMgU2hpeWlQYWdlRXh0ZXJuQmFzZTxQYWdlVD4ge1xyXG4gICAgcHVibGljIEluaXQoKTogU2hpeWlQYWdlRXh0ZXJuQmFzZTxQYWdlVD4ge1xyXG4gICAgICAgIHN1cGVyLkluaXQoKTtcclxuICAgICAgICB0aGlzLkxvYWRHbG9iYWxVSUNvbmZpZygpO1xyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG4gICAgcHVibGljIExvYWRHbG9iYWxVSUNvbmZpZygpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLlBhZ2VJbnN0YW5jZS5CaW5kR2xvYmFsKEdsb2JhbERhdGEuVGhlbWUsIFwiVGhlbWVcIixcclxuICAgICAgICAgICAgKHZhbHVlOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPyBcIkRhcmtcIiA6IFwiXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApXHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUGFnZURhdGEge1xyXG4gICAgVGhlbWU6IHN0cmluZ1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFBlc3Vkb0NvbXBuZW50U3RhY2t7XHJcblxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFNoaXlpUGFnZUJhc2UgZXh0ZW5kcyBXZWNoYXRNaW5pcHJvZ3JhbS5QYWdlLkluc3RhbmNlTWV0aG9kczxXZWNoYXRNaW5pcHJvZ3JhbS5Db21wb25lbnQuRGF0YU9wdGlvbj4ge1xyXG5cclxufVxyXG5cclxuaW50ZXJmYWNlIE9ic2VydmVyVGFyZ2V0PERhdGFUPiB7XHJcbiAgICBuYW1lOiBzdHJpbmc7XHJcbiAgICBQcmVQcm9jZXNzPzogKHZhbHVlOiBEYXRhVCkgPT4gYW55O1xyXG59XHJcblxyXG5pbnRlcmZhY2UgT2JzZXJ2ZXJCYWNrd2FyZFRhcmdldDxEYXRhVD4ge1xyXG4gICAgVGFyZ2V0RGF0YU9iajogRGF0YTxhbnk+O1xyXG4gICAgUHJlUHJvY2Vzcz86ICh2YWx1ZTogRGF0YVQpID0+IGFueTtcclxufVxyXG4gXHJcblxyXG5cclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFNoaXlpUGFnZUJhc2VcclxuICAgIGltcGxlbWVudHMgV2VjaGF0TWluaXByb2dyYW0uUGFnZS5PcHRpb25zPFxyXG4gICAgV2VjaGF0TWluaXByb2dyYW0uUGFnZS5EYXRhT3B0aW9uLFxyXG4gICAgV2VjaGF0TWluaXByb2dyYW0uUGFnZS5DdXN0b21PcHRpb25cclxuICAgID57XHJcbiAgICBwdWJsaWMgZGF0YSE6IFBhZ2VEYXRhO1xyXG4gICAgcHVibGljIEZ1bmMhOiBTaGl5aVBhZ2VFeHRlcm5CYXNlPFNoaXlpUGFnZUJhc2U+O1xyXG4gICAgcHVibGljIFVJITogU2hpeWlQYWdlRXh0ZXJuQmFzZTxTaGl5aVBhZ2VCYXNlPjtcclxuICAgIC8vI3JlZ2lvbiDkuovku7blpITnkIZcclxuICAgIHB1YmxpYyBDb21wb25lbnRTdGFjazogQXJyYXk8U2hpeWlDb21wb25lbnRCYXNlPiA9IG5ldyBBcnJheTxTaGl5aUNvbXBvbmVudEJhc2U+KCk7XHJcbiAgICBwdWJsaWMgUmVnaXN0ZXJlZEV2ZW50SGFuZGxlcnM6IFJlY29yZDxzdHJpbmcsIChlOiBFdmVudCkgPT4gdm9pZD4gPSB7fTtcclxuICAgIHB1YmxpYyBQZXN1ZG9Db21wbmVudHMhOlBlc3Vkb0NvbXBuZW50U3RhY2s7XHJcbiAgICAvKipcclxuICAgICAqIOe7keWumuS6i+S7tuWkhOeQhuaWueazlVxyXG4gICAgICogQHBhcmFtIFRyaWdnZXIg5LqL5Lu25ZCNXHJcbiAgICAgKiBAcGFyYW0gSGFuZGxlciDlpITnkIbmlrnms5VcclxuICAgICAqL1xyXG4gICAgcHVibGljIEJpbmRFdmVudChUcmlnZ2VyOiBzdHJpbmcsIEhhbmRsZXI6IChlOiBFdmVudCkgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuQWRkSGFuZGxlcihUcmlnZ2VyLCBIYW5kbGVyKTtcclxuICAgIH1cclxuICAgIHB1YmxpYyBBZGRIYW5kbGVyKFRyaWdnZXI6IHN0cmluZywgSGFuZGxlcjogKGU6IEV2ZW50KSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5SZWdpc3RlcmVkRXZlbnRIYW5kbGVyc1tUcmlnZ2VyXSA9IEhhbmRsZXI7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgUmVtb3ZlaGFuZGxlcihUcmlnZ2VyOiBzdHJpbmcsIEhhbmRsZXI6IChlOiBFdmVudCkgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLlJlZ2lzdGVyZWRFdmVudEhhbmRsZXJzW1RyaWdnZXJdID09PSBIYW5kbGVyKSB7XHJcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLlJlZ2lzdGVyZWRFdmVudEhhbmRsZXJzW1RyaWdnZXJdO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgRXZlbnRIYW5kbGVyKGU6IEV2ZW50KTogdm9pZCB7XHJcbiAgICAgICAgZS5DYXRjaCgpO1xyXG4gICAgICAgIGxldCBIYW5kbGVyID0gdGhpcy5SZWdpc3RlcmVkRXZlbnRIYW5kbGVyc1tlLkV2ZW50TmFtZV07XHJcbiAgICAgICAgY29uc29sZS5sb2coSGFuZGxlcik7XHJcbiAgICAgICAgaWYgKEhhbmRsZXIpIHtcclxuICAgICAgICAgICAgSGFuZGxlcihlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBlLlBhc3MoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyNlbmRyZWdpb25cclxuXHJcbiAgICAvLyNyZWdpb24g5pWw5o2u57uR5a6aXHJcbiAgICBwcml2YXRlIE9ic2VydmVyTGlzdDogUmVjb3JkPHN0cmluZywgT2JzZXJ2ZXJUYXJnZXQ8YW55Pj4gPSB7fTtcclxuICAgIC8qKlxyXG4gICAgICog5YWo5bGA5pWw5o2u57uR5a6aXHJcbiAgICAgKiBAcGFyYW0gZGF0YSDnu5HlrprmlbDmja7mupBcclxuICAgICAqIEBwYXJhbSB0YXJnZXQg57uR5a6a5pys6aG16Z2i55qE5pWw5o2uXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBBZGRPYnNlcnZlcjxEYXRhVD4oZGF0YTogRGF0YTxEYXRhVD4sIHRhcmdldDogT2JzZXJ2ZXJUYXJnZXQ8RGF0YVQ+KSB7XHJcbiAgICAgICAgdGhpcy5PYnNlcnZlckxpc3RbZGF0YS5EYXRhS2V5XSA9IHRhcmdldDtcclxuICAgICAgICBkYXRhLkJpbmQodGhpcyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIFJlbW92ZU9ic2VydmVyPERhdGFUPihkYXRhOiBEYXRhPERhdGFUPikge1xyXG4gICAgICAgIGlmICh0aGlzLk9ic2VydmVyTGlzdFtkYXRhLkRhdGFLZXldKSB7XHJcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLk9ic2VydmVyTGlzdFtkYXRhLkRhdGFLZXldO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgT2JzZXJ2ZXJOb3RpZnkoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcclxuICAgICAgICBsZXQgdGFyZ2V0ID0gdGhpcy5PYnNlcnZlckxpc3Rba2V5XTtcclxuICAgICAgICBpZiAodGFyZ2V0KSB7XHJcbiAgICAgICAgICAgIHRoaXMuUmVuZGVyTm9CYWNrd2FyZCh7XHJcbiAgICAgICAgICAgICAgICBbdGFyZ2V0Lm5hbWVdOiB0YXJnZXQuUHJlUHJvY2VzcyA/IHRhcmdldC5QcmVQcm9jZXNzKHZhbHVlKSA6IHZhbHVlXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlhajlsYDmlbDmja7nu5HlrppcclxuICAgICAqIEB0eXBlIHtHbG9iYWxEYXRhVH0g5YWo5bGA5pWw5o2u57G75Z6LXHJcbiAgICAgKiBAdHlwZSB7VH0g6aG16Z2i5Lit5rS+55Sf6IeqUGFnZURhdGHnmoRkYXRh57G75Z6LXHJcbiAgICAgKiBAcGFyYW0gR2xvYmFsRGF0YSDlhajlsYDmlbDmja5PYmplY3RcclxuICAgICAqIEBwYXJhbSBTZWxmRGF0YUtleSDoh6rouqvmlbDmja5LZXlcclxuICAgICAqIEBwYXJhbSBQcmVQcm9jZXNzIOmihOWkhOeQhuaWueW8j1xyXG4gICAgICovXHJcbiAgICBwdWJsaWMgQmluZEdsb2JhbDxHbG9iYWxEYXRhVCwgVCBleHRlbmRzIFBhZ2VEYXRhPihcclxuICAgICAgICBHbG9iYWxEYXRhOiBEYXRhPEdsb2JhbERhdGFUPixcclxuICAgICAgICBTZWxmRGF0YUtleToga2V5b2YgVCxcclxuICAgICAgICBQcmVQcm9jZXNzPzogKHZhbHVlOiBHbG9iYWxEYXRhVCkgPT4gYW55KSB7XHJcbiAgICAgICAgdGhpcy5BZGRPYnNlcnZlcjxHbG9iYWxEYXRhVD4oR2xvYmFsRGF0YSwge1xyXG4gICAgICAgICAgICBuYW1lOiBTZWxmRGF0YUtleSBhcyBzdHJpbmcsXHJcbiAgICAgICAgICAgIFByZVByb2Nlc3M6IFByZVByb2Nlc3NcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgUmVnaXN0ZXJlZEdsb2JhbEJhY2tXYXJkQmluZGluZzogUmVjb3JkPHN0cmluZyxBcnJheTwgT2JzZXJ2ZXJCYWNrd2FyZFRhcmdldDxhbnk+Pj4gPSB7fTtcclxuXHJcbiAgICBwdWJsaWMgQmluZEdsb2JhbEJhY2t3YXJkPFNlbGZEYXRhVCwgVCBleHRlbmRzIFBhZ2VEYXRhPihcclxuICAgICAgICBTZWxmRGF0YUtleToga2V5b2YgVCxcclxuICAgICAgICBHbG9iYWxEYXRhT2JqOiBEYXRhPGFueT4sXHJcbiAgICAgICAgUHJlUHJvY2Vzcz86ICh2YWx1ZTogU2VsZkRhdGFUKSA9PiBhbnkpIHtcclxuICAgICAgICAgICAgaWYoIXRoaXMuUmVnaXN0ZXJlZEdsb2JhbEJhY2tXYXJkQmluZGluZ1tTZWxmRGF0YUtleSBhcyBzdHJpbmddKXtcclxuICAgICAgICAgICAgICAgIHRoaXMuUmVnaXN0ZXJlZEdsb2JhbEJhY2tXYXJkQmluZGluZ1tTZWxmRGF0YUtleSBhcyBzdHJpbmddPW5ldyBBcnJheTwgT2JzZXJ2ZXJCYWNrd2FyZFRhcmdldDxhbnk+PigpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuUmVnaXN0ZXJlZEdsb2JhbEJhY2tXYXJkQmluZGluZ1tTZWxmRGF0YUtleSBhcyBzdHJpbmddLnB1c2goIHtcclxuICAgICAgICAgICAgICAgIFwiVGFyZ2V0RGF0YU9ialwiOkdsb2JhbERhdGFPYmosXHJcbiAgICAgICAgICAgICAgICBcIlByZVByb2Nlc3NcIjpQcmVQcm9jZXNzXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5YWo5bGA5pWw5o2u5Y+M5ZCR57uR5a6aXHJcbiAgICAgKiBAcGFyYW0gU2VsZkRhdGFLZXkg6Ieq6Lqr5pWw5o2uS2V5XHJcbiAgICAgKiBAcGFyYW0gR2xvYmFsRGF0YU9iaiDlhajlsYDmlbDmja5PYmplY3RcclxuICAgICAqIEBwYXJhbSBTZWxmVG9HbG9iYWxQcmVQcm9jZXNzIOiHqui6q+aVsOaNruWIsOWFqOWxgOaVsOaNrueahOmihOWkhOeQhlxyXG4gICAgICogQHBhcmFtIEdsb2JhbFRvU2VsZlByZVByb2Nlc3Mg5YWo5bGA5pWw5o2u5Yiw6Ieq6Lqr5pWw5o2u55qE6aKE5aSE55CGXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBCaW5kR2xvYmFsVHdvV2F5PFNlbGZEYXRhVCxHbG9iYWxEYXRhVCwgVCBleHRlbmRzIFBhZ2VEYXRhPihcclxuICAgICAgICBTZWxmRGF0YUtleToga2V5b2YgVCxcclxuICAgICAgICBHbG9iYWxEYXRhT2JqOiBEYXRhPEdsb2JhbERhdGFUPixcclxuICAgICAgICBTZWxmVG9HbG9iYWxQcmVQcm9jZXNzPzogKHZhbHVlOiBTZWxmRGF0YVQpID0+IEdsb2JhbERhdGFULFxyXG4gICAgICAgIEdsb2JhbFRvU2VsZlByZVByb2Nlc3M/OiAodmFsdWU6IEdsb2JhbERhdGFUKSA9PiBTZWxmRGF0YVQpe1xyXG4gICAgICAgICAgICB0aGlzLkJpbmRHbG9iYWw8R2xvYmFsRGF0YVQsVD4oR2xvYmFsRGF0YU9iaixTZWxmRGF0YUtleSxHbG9iYWxUb1NlbGZQcmVQcm9jZXNzKTtcclxuICAgICAgICAgICAgdGhpcy5CaW5kR2xvYmFsQmFja3dhcmQ8U2VsZkRhdGFULFQ+KFNlbGZEYXRhS2V5LEdsb2JhbERhdGFPYmosU2VsZlRvR2xvYmFsUHJlUHJvY2Vzcyk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgUmVnaXN0ZXJlZFNlbGZCaW5kaW5nOiBSZWNvcmQ8c3RyaW5nLEFycmF5PE9ic2VydmVyVGFyZ2V0PGFueT4+PiA9IHt9O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog6aG16Z2i5pWw5o2u6Ieq57uR5a6aXHJcbiAgICAgKiBAdHlwZSB7U3JjRGF0YVR9IOa6kOaVsOaNruexu+Wei1xyXG4gICAgICogQHR5cGUge1R9IOmhtemdouS4rea0vueUn+iHqlBhZ2VEYXRh55qEZGF0Yeexu+Wei1xyXG4gICAgICogQHBhcmFtIFNyY0tleSDmupDmlbDmja5LZXlcclxuICAgICAqIEBwYXJhbSBUYXJnZXRLZXkg55uu5qCH5pWw5o2uS2V5XHJcbiAgICAgKiBAcGFyYW0gUHJlUHJvY2VzcyDpooTlpITnkIbmlrnlvI9cclxuICAgICAqL1xyXG4gICAgcHVibGljIEJpbmRTZWxmPFNyY0RhdGFULCBUIGV4dGVuZHMgUGFnZURhdGE+KFNyY0tleToga2V5b2YgVCwgVGFyZ2V0S2V5OiBrZXlvZiBULCBQcmVQcm9jZXNzPzogKHZhbHVlOiBTcmNEYXRhVCkgPT4gYW55KSB7XHJcbiAgICAgICAgaWYoIXRoaXMuUmVnaXN0ZXJlZFNlbGZCaW5kaW5nW1NyY0tleSBhcyBzdHJpbmddKXtcclxuICAgICAgICAgICAgdGhpcy5SZWdpc3RlcmVkU2VsZkJpbmRpbmdbU3JjS2V5IGFzIHN0cmluZ109bmV3IEFycmF5PE9ic2VydmVyVGFyZ2V0PGFueT4+KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuUmVnaXN0ZXJlZFNlbGZCaW5kaW5nW1NyY0tleSBhcyBzdHJpbmddIC5wdXNoKHtcclxuICAgICAgICAgICAgbmFtZTogVGFyZ2V0S2V5IGFzIHN0cmluZyxcclxuICAgICAgICAgICAgUHJlUHJvY2VzczogUHJlUHJvY2Vzc1xyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIEJpbmRTZWxmVHdvV2F5PEZpcnN0RGF0YVQsU2VjRGF0YVQsIFQgZXh0ZW5kcyBQYWdlRGF0YT4oXHJcbiAgICAgICAgRmlyc3REYXRhOmtleW9mIFQsXHJcbiAgICAgICAgU2VjRGF0YTprZXlvZiBULFxyXG4gICAgICAgIEZpcnN0VG9TZWNQcmVQcm9jZXNzPzogKHZhbHVlOiBGaXJzdERhdGFUKSA9PiBTZWNEYXRhVCxcclxuICAgICAgICBTZWNUb0ZpcnN0UHJlUHJvY2Vzcz86ICh2YWx1ZTogU2VjRGF0YVQgKSA9PiBGaXJzdERhdGFUXHJcbiAgICApe1xyXG4gICAgICAgIHRoaXMuQmluZFNlbGY8Rmlyc3REYXRhVCxUPihGaXJzdERhdGEsU2VjRGF0YSxGaXJzdFRvU2VjUHJlUHJvY2Vzcyk7XHJcbiAgICAgICAgdGhpcy5CaW5kU2VsZjxTZWNEYXRhVCxUPihTZWNEYXRhLEZpcnN0RGF0YSxTZWNUb0ZpcnN0UHJlUHJvY2Vzcyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIFJlbmRlcjxUIGV4dGVuZHMgUGFnZURhdGE+KHZhbHVlOiBQYXJ0aWFsPFJlY29yZDxrZXlvZiBULCBhbnk+Pil7XHJcbiAgICAgICAgdGhpcy5fcmVuZGVyPFQ+KHZhbHVlLGZhbHNlKTtcclxuICAgIH1cclxuICAgIHB1YmxpYyBSZW5kZXJOb0JhY2t3YXJkPFQgZXh0ZW5kcyBQYWdlRGF0YT4odmFsdWU6IFBhcnRpYWw8UmVjb3JkPGtleW9mIFQsIGFueT4+KXtcclxuICAgICAgICB0aGlzLl9yZW5kZXI8VD4odmFsdWUsdHJ1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfcmVuZGVyPFQgZXh0ZW5kcyBQYWdlRGF0YT4odmFsdWU6IFBhcnRpYWw8UmVjb3JkPGtleW9mIFQsIGFueT4+LERpc2FibGVCYWNrd2FyZDpib29sZWFuKSB7XHJcbiAgICAgICAgbGV0IE1vZGlmaWVkID0gZmFsc2U7XHJcbiAgICAgICAgbGV0IEtleXMgPSBPYmplY3Qua2V5cyh2YWx1ZSlcclxuICAgICAgICB0eXBlIERhdGFLZXlzID0ga2V5b2YgVDtcclxuICAgICAgICBLZXlzLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuUmVnaXN0ZXJlZFNlbGZCaW5kaW5nW2tleV0pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuUmVnaXN0ZXJlZFNlbGZCaW5kaW5nW2tleV0uZm9yRWFjaCgodGFyZ2V0KT0+e1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChLZXlzLmluZGV4T2YodGFyZ2V0Lm5hbWUgYXMgc3RyaW5nKSA8IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgTW9kaWZpZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LlByZVByb2Nlc3MpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlW3RhcmdldC5uYW1lIGFzIERhdGFLZXlzXSA9IHRhcmdldC5QcmVQcm9jZXNzKHZhbHVlW2tleSBhcyBEYXRhS2V5c10pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVbdGFyZ2V0Lm5hbWUgYXMgRGF0YUtleXNdID0gdmFsdWVba2V5IGFzIERhdGFLZXlzXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYoIURpc2FibGVCYWNrd2FyZCYmdGhpcy5SZWdpc3RlcmVkR2xvYmFsQmFja1dhcmRCaW5kaW5nW2tleV0pe1xyXG4gICAgICAgICAgICAgICAgdGhpcy5SZWdpc3RlcmVkR2xvYmFsQmFja1dhcmRCaW5kaW5nW2tleV0uZm9yRWFjaCh0YXJnZXQ9PntcclxuICAgICAgICAgICAgICAgICAgICB0YXJnZXQuVGFyZ2V0RGF0YU9iai5TZXQoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5QcmVQcm9jZXNzP1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQuUHJlUHJvY2Vzcyh2YWx1ZVtrZXkgYXMgRGF0YUtleXNdKTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVba2V5IGFzIERhdGFLZXlzXSk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKE1vZGlmaWVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3JlbmRlcjxUPih2YWx1ZSxEaXNhYmxlQmFja3dhcmQpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh2YWx1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8jZW5kcmVnaW9uXHJcblxyXG4gICAgcHJvdGVjdGVkIExvYWRQZXN1ZG9Db21wb25lbnRzKCk6dm9pZCB7XHJcbiAgICAgICAgbGV0IGNvbXBvbmVudHMgPSB0aGlzLlBlc3Vkb0NvbXBuZW50cyBhcyBSZWNvcmQ8c3RyaW5nLCBQZXN1ZG9Db21wbmVudD47XHJcbiAgICAgICAgT2JqZWN0LmtleXMoY29tcG9uZW50cykuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgQ29tcCA9IGNvbXBvbmVudHNba2V5XTtcclxuICAgICAgICAgICAgQ29tcC5QYWdlSW5zdGFuY2U9dGhpcztcclxuICAgICAgICAgICAgQ29tcC5fUmVuZGVyPXRoaXMuUmVuZGVyLmJpbmQodGhpcyk7XHJcbiAgICAgICAgICAgIGxldCBDb21wUHJvdG8gPSBDb21wO1xyXG4gICAgICAgICAgICBsZXQgQ29tcElkID0gY29tcG9uZW50c1trZXldLkNvbXBvbmVudElkO1xyXG4gICAgICAgICAgICB3aGlsZShDb21wUHJvdG8pe1xyXG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXMoQ29tcFByb3RvKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIENvbXBQcm90b1trZXldPT1cImZ1bmN0aW9uXCIpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tDb21wSWQgKyBrZXldPUNvbXBQcm90b1trZXldLmJpbmQoQ29tcCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBDb21wUHJvdG89IE9iamVjdC5nZXRQcm90b3R5cGVPZihDb21wUHJvdG8pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCBDb21wRGF0YTpSZWNvcmQ8c3RyaW5nLGFueT4gPSB7fTtcclxuICAgICAgICAgICAgT2JqZWN0LmtleXMoY29tcG9uZW50c1trZXldLmRhdGEpLmZvckVhY2goZGF0YWtleT0+e1xyXG4gICAgICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICBDb21wRGF0YVtDb21wSWQrZGF0YWtleV09Y29tcG9uZW50c1trZXldLmRhdGFbZGF0YWtleV07XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIHRoaXMuUmVuZGVyKENvbXBEYXRhKTtcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBMb2FkRXh0ZW5kcygpe1xyXG4gICAgICAgIHRoaXMuRnVuYy5QYWdlSW5zdGFuY2U9dGhpcztcclxuICAgICAgICB0aGlzLkZ1bmMuSW5pdCgpO1xyXG4gICAgICAgIHRoaXMuVUkuUGFnZUluc3RhbmNlPXRoaXM7XHJcbiAgICAgICAgdGhpcy5VSS5Jbml0KCk7XHJcbiAgICAgICAgdGhpcy5VSS5Jbml0Q3VzdG9tRGF0YSgpO1xyXG4gICAgICAgIHRoaXMuRnVuYy5Jbml0Q3VzdG9tRGF0YSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBJblBhcmFtZXRlcjogYW55XHJcbiAgICBwdWJsaWMgb25Mb2FkKCkge1xyXG4gICAgICAgIFJvdXRlci5QYWdlTG9hZCh0aGlzKTtcclxuICAgICAgICB0aGlzLkxvYWRQZXN1ZG9Db21wb25lbnRzKCk7XHJcbiAgICAgICAgdGhpcy5Mb2FkRXh0ZW5kcygpO1xyXG4gICAgICAgIHRoaXMuSW5QYXJhbWV0ZXIgPSBSb3V0ZXIuTmF2aWdhdGVQYXJhbTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgb25VbmxvYWQoKSB7XHJcbiAgICAgICAgUm91dGVyLlBhZ2VVbmxvYWQoKTtcclxuICAgIH1cclxufTsiXX0=